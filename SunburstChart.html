<html>
    <head>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="Data/d3-scale-chromatic.v1.min.js"></script>

        <link rel="stylesheet" href="Data/general.css" />
        <script src="./Data/utils.js"></script>

        <title>Sunburst Chart</title>

        <style>
            body {
                font-family: Sans-serif;
            }

            .slice {
                cursor: pointer;
            }

            .slice .main-arc {
                stroke: #fff;
                stroke-width: 0px;
            }

            .slice .hidden-arc {
                fill: none;
            }

            .slice text {
                pointer-events: none;
                dominant-baseline: middle;
                text-anchor: middle;
            }
            #my_dataviz {
                height: 100vh;
                margin-left: 0;
            }
        </style>
    </head>
    <body>
        <div id="my_dataviz"></div>
        <div id="tooltip"></div>
        <div id="legend"></div>
        <script>
            // Color Pallets - Set 3
            const d3colors = [
                "#8DD3C9",
                "#FFFFAA",
                "#B8BED6",
                "#F98171",
                "#78B5D1",
                "#FFB15B",
                "#B4E061",
                "#FDCDE5",
                "#DAD9D4",
                "#BD7FBE",
                "#CDE9C1",
                "#FFEA77",
            ];

            function drawChart(data, plottingConfiguration = {}) {
                window.data = data;
                [data, labels] = data;
                // labels = data[1];
                console.log({ labels });
                // data = { name: "", children: data };
                let {
                    d3colorPalette,
                    paddingInner,
                    markerShape,
                    curveType,
                    toolTip,
                    labelConfig = defaultD3Config.defaultlabelConfig,
                    legendConfig = defaultD3Config.defaultLegendConfig,
                    dataLabelfontSize = defaultD3Config.fontSize,
                    dataLabelfontFamily = defaultD3Config.fontFamily,
                    dataLabelColor = defaultD3Config.fontColor,
                } = plottingConfiguration;
                window.dataLabelfontSize = dataLabelfontSize;
                window.dataLabelfontFamily = dataLabelfontFamily;
                window.dataLabelColor = dataLabelColor;
                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }

                let { legendStatus, legendPosition } = legendConfig;
                d3Colors = d3colorPalette;
                let { labelStatus, labelFormat } = labelConfig;
                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                // legends code starts
                d3.select("#legend").html("").style("padding", "");
                // if (legendStatus) {
                if (false) {
                    d3.select("#legend").html("");

                    d3.select("#legend")
                        .append("p")
                        .html("xAxisLabel" + "&nbsp;")
                        .style("font-weight", "bold")
                        .style("margin", "auto")
                        .style("position", "sticky");

                    d3.select("#legend")
                        .selectAll("div")
                        .data("[data[1][0]]")
                        .enter()
                        .append("div")
                        .html((d, i) => {
                            return (
                                '<div style="width: 15px; height: 15px; margin-top:2px; background: ' +
                                d3Colors[i % d3Colors.length] +
                                ';">  </div>' +
                                "<span style='margin-left: 5px; max-width: 160px'>" +
                                d +
                                "</span>"
                            );
                        })
                        .style("display", "flex")
                        .style("padding", "2px");
                }

                // legends code ends

                // legends height ,width elements
                var legendElement = document.querySelector("#legend");
                var legendHeight = legendElement.offsetHeight;
                var legendWidth = legendElement.offsetWidth;

                // const yAxisWidth =
                //     document.querySelector("#yAxisDiv").clientWidth;

                d3.select("#legend").attr("style", null);
                d3.select("#mainChartWindow").attr("style", null);
                d3.select("#xAxisLabelId").style("bottom", 20);

                // legends code starts
                if (legendStatus) {
                    if (
                        legendHeight <
                        document.querySelector("html").offsetHeight
                    ) {
                        topPosition = "calc(50vh - " + legendHeight / 2 + "px)";
                    } else {
                        topPosition = 0;
                    }
                    rightPosition = "calc(50vw - " + legendWidth / 2 + "px)";

                    //  var widthOld = (document.querySelector("#my_dataviz").clientWidth) ;
                    var widthOld =
                        document.querySelector("html").clientWidth - 72;
                    var heightOld = document.querySelector("html").clientHeight;

                    // legendElement.style.padding = "10px";
                    legendElement.style.border = "1px solid black";
                    d3.selectAll("#my_dataviz").style("margin-top", 0 + "px");

                    switch (legendPosition) {
                        case "left":
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", topPosition)
                                .style("right", "auto")
                                // .style("bottom", "auto")
                                .style("left", "0px")
                                // .style("right", "5px")
                                .style("display", "block")
                                .style("max-height", "100vh")
                                .style("overflow", "scroll")
                                .style("border", "none")
                                .style("position", "fixed");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            var legendWidth = legendElement.offsetWidth;
                            // margin.left += 100;
                            // width -= 100;
                            // d3.select("#my_dataviz svg").attr("width", width + margin.left + margin.right);

                            d3.select("#mainChartWindow").attr("style", null);

                            // d3.select("#mainChartWindow").style(
                            //     "width",
                            //     widthOld - legendWidth + yAxisWidth
                            // );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                legendWidth + "px"
                            );
                            d3.select("#xAxisLabelId").style(
                                "bottom",
                                10 + "px"
                            );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh)"
                            );

                            break;
                        case "top":
                            d3.select("#mainChartWindow").attr("style", null);
                            // margin.top += 50;
                            // height -= 50;
                            y_pos_x_label = 57;
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", "10px")
                                .style("right", rightPosition)
                                .style("bottom", "auto")
                                .style("left", "auto")
                                .style("display", "flex")
                                .style("max-width", "99vw")
                                .style("overflow", "scroll")
                                .style("border", "none");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");
                            d3.select("#xAxisLabelId").style(
                                "bottom",
                                10 + "px"
                            );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh - 72px) "
                            );
                            d3.selectAll("#my_dataviz").style(
                                "margin-top",
                                30 + "px"
                            );

                            // d3.selectAll("#legend div").style(
                            //     "padding",
                            //     "2px 4px"
                            // );
                            break;
                        case "bottom":
                            // height -= 50; // use legend client height
                            // margin.bottom += 10;
                            var legendWidth = legendElement.offsetWidth;
                            y_pos_x_label = 20;

                            d3.select("#xAxisLabelId").style("bottom", "60px");
                            d3.select("#mainChartWindow").attr("style", null);

                            // d3.select("#mainChartWindow").style("width", width);
                            //  d3.select("#mainChartWindow").style("height",heightOld-80 );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                0
                            );
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", "auto")
                                .style("right", rightPosition)
                                .style("bottom", "0px")
                                // .style("left", margin.left + "px")
                                .style("display", "flex")
                                .style("max-width", "99vw")
                                .style("overflow", "scroll")
                                .style("border", "none");

                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh - 42px)"
                            );

                            break;
                        // For Right Legened
                        case "right":
                        default:
                            // width -= 220;
                            // d3.select("#my_dataviz").style("width", width + margin.left + margin.right);
                            var legendWidth = legendElement.offsetWidth;

                            d3.select("#legend")
                                .attr("style", null)
                                .style("right", "0px")
                                .style("left", "auto")
                                .style("position", "fixed")
                                .style("top", topPosition)
                                .style("max-height", "100vh")
                                .style("overflow", "scroll")
                                .style("border", "none")
                                .style("bottom", "auto")
                                .style("display", "block");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            d3.select("#mainChartWindow").attr("style", null);
                            // d3.select("#mainChartWindow").style(
                            //     "width",
                            //     widthOld - legendWidth  - 10 + "px"
                            // );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                0
                            );
                            d3.select("#xAxisLabelId").style(
                                "bottom",
                                10 + "px"
                            );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh)"
                            );
                    }
                }

                // if (legendPosition == "left" || legendPosition == "right") {
                //     var legendWidth = legendElement.offsetWidth;
                //     width -= legendWidth;
                // }

                // legends code ends

                d3.selectAll("#my_dataviz").html("");
                (margin = { top: 30, right: 30, bottom: 70, left: 60 }),
                    (width =
                        window.innerWidth - margin.left - margin.right - 20),
                    (height =
                        window.innerHeight - margin.top - margin.bottom - 30);

                maxRadius = Math.min(width, height) / 2;

                const formatNumber = d3.format(",d");

                const x = d3
                    .scaleLinear()
                    .range([0, 2 * Math.PI])
                    .clamp(true);

                const y = d3.scaleSqrt().range([maxRadius * 0.1, maxRadius]);

                const color = d3.scaleOrdinal(d3Colors);

                const partition = d3.partition();

                const arc = d3
                    .arc()
                    .startAngle((d) => x(d.x0))
                    .endAngle((d) => x(d.x1))
                    .innerRadius((d) => Math.max(0, y(d.y0)))
                    .outerRadius((d) => Math.max(0, y(d.y1)));

                const middleArcLine = (d) => {
                    const halfPi = Math.PI / 2;
                    const angles = [x(d.x0) - halfPi, x(d.x1) - halfPi];
                    const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);

                    const middleAngle = (angles[1] + angles[0]) / 2;
                    const invertDirection =
                        middleAngle > 0 && middleAngle < Math.PI; // On lower quadrants write text ccw
                    if (invertDirection) {
                        angles.reverse();
                    }

                    const path = d3.path();
                    path.arc(0, 0, r, angles[0], angles[1], invertDirection);
                    return path.toString();
                };

                const textFits = (d) => {
                    const CHAR_SPACE = 6;

                    const deltaAngle = x(d.x1) - x(d.x0);
                    const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);
                    const perimeter = r * deltaAngle;

                    return d.data.name.length * CHAR_SPACE < perimeter;
                };

                const svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr(
                        "viewBox",
                        `${-width / 2} ${-(height / 2) - 5} ${width} ${
                            height + 40
                        }`
                    )
                    .on("click", () => focusOn()); // Reset zoom on canvas click

                data = d3.hierarchy(data);
                data.sum((d) => d.size);

                const slice = svg
                    .selectAll("g.slice")
                    .data(partition(data).descendants());

                slice.exit().remove();

                const newSlice = slice
                    .enter()
                    .append("g")
                    .attr("class", "slice")
                    .on("click", (d) => {
                        d3.event.stopPropagation();
                        focusOn(d);
                    });

                newSlice
                    .append("path")
                    .attr("class", "main-arc")
                    .style("fill", (d) =>
                        color((d.children ? d : d.parent).data.name)
                    )
                    .attr("d", arc)
                    .on("mouseover mousemove", function (d, i) {
                        var x_pos = d3.mouse(this)[0] + width / 2 + 70;
                        var y_pos = d3.mouse(this)[1] + height / 2 - 20;

                        d3.select("#tooltip")
                            .style("left", x_pos + "px")
                            .style("top", y_pos + 120 + "px")
                            .style("display", "block")
                            .style("z-index", 1000)
                            .style("postion", "absolute")
                            // .style("height", (d.depth?"":"6"))
                            // .text(d.data.name + ":" + d.value);
                            .html(function () {
                                var textValue = d.y0 - d.y1;
                                if (d.y1 < 0) {
                                    textValue = d.y1 - d.y0;
                                }
                                if (!toolTip || Object.keys(toolTip).length == 0) {
                                    toolTip = {
                                        textColumn1: d.data.label,
                                        // textColumn1: d.data.name,
                                        textColumn2: labels[labels.length - 1],
                                    };
                                }
                                return (
                                    
                                    "<div class='arrowTooltip'></div>" +
                                    (d.depth
                                        ? "<span style='color:grey;''>" +
                                          d.data.label +
                                          ":&nbsp;&nbsp;" +
                                          "</span>" +
                                          "<span style='float: right;'>" +
                                          d.data.name +
                                          "</span>" +
                                          "<br/> <br/>"
                                        : "") +
                                    "<span style='color:grey;''>" +
                                    toolTip.textColumn2 +
                                    ":" +
                                    "</span>" +
                                    "<span style='float: right;margin-left: 15px;'>" +
                                    d.data.size +
                                    "</span>"
                                );
                            });
                        d3.select(".arrowTooltip").attr(
                            "style",
                            "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';left: -12px; transform: rotate(90deg)!important;bottom: 22px; position: absolute;"
                        );

                        d3.select(this)
                            .style("fill", d3Colors[0])
                            .attr("stroke", "gray")
                            .attr("stroke-width", 1);
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.select(this)
                            .attr("stroke", "")
                            .attr("stroke-width", 0);
                        d3.select(this).style(
                            "fill",
                            color((d.children ? d : d.parent).data.name)
                        );
                    });

                newSlice
                    .append("path")
                    .attr("class", "hidden-arc")
                    .attr("id", (_, i) => `hiddenArc${i}`)
                    .attr("d", middleArcLine);

                const text = newSlice
                    .append("text")
                    .attr("display", (d) => (textFits(d) ? null : "none"));

                if (labelStatus) {
                    text.append("textPath")
                        .attr("startOffset", "50%")
                        .attr("xlink:href", (_, i) => `#hiddenArc${i}`)
                        // .text((d) => labelFormatSet(d.data.name, labelFormat))
                        .text((d) => d.data.name)
                        .attr("font-family", dataLabelfontFamily)
                        .attr("font-size", dataLabelfontSize)
                        .attr("fill", dataLabelColor);
                }

                function focusOn(d = { x0: 0, x1: 1, y0: 0, y1: 1 }) {
                    // Reset to top-level if no data point specified

                    const transition = svg
                        .transition()
                        .duration(750)
                        .tween("scale", () => {
                            const xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                                yd = d3.interpolate(y.domain(), [d.y0, 1]);
                            return (t) => {
                                x.domain(xd(t));
                                y.domain(yd(t));
                            };
                        });

                    transition
                        .selectAll("path.main-arc")
                        .attrTween("d", (d) => () => arc(d));

                    transition
                        .selectAll("path.hidden-arc")
                        .attrTween("d", (d) => () => middleArcLine(d));

                    transition
                        .selectAll("text")
                        .attrTween(
                            "display",
                            (d) => () => textFits(d) ? null : "none"
                        );

                    moveStackToFront(d);

                    //

                    function moveStackToFront(elD) {
                        svg.selectAll(".slice")
                            .filter((d) => d === elD)
                            .each(function (d) {
                                this.parentNode.appendChild(this);
                                if (d.parent) {
                                    moveStackToFront(d.parent);
                                }
                            });
                    }
                }
            }
            //  drawChart(data); 

            // window.addEventListener("resize", function () {
            // drawChart(data);
            // });
        </script>
    </body>
</html>
